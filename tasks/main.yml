---
- name: Install awscli using pip
  when: awscli_package_pip_install
  block:
    - name: Ensure awscli package is not installed
      ansible.builtin.package:
        name: awscli
        state: absent

    - name: Ensure pip is installed
      ansible.builtin.package:
        name: python3-pip
        state: present
        update_cache: true

    - name: Ensure awscli python package is installed
      ansible.builtin.pip:
        name: awscli
        state: "{{ awscli_package_state }}"

- name: Install awscli using apt
  when: not awscli_package_pip_install
  block:
    - name: Gather facts about installed packages
      ansible.builtin.package_facts:
        manager: auto

    - name: Ensure awscli python package is not installed if pip is installed
      ansible.builtin.pip:
        name: awscli
        state: absent
      when: "'python3-pip' in ansible_facts.packages"

    - name: Ensure awscli package is installed
      ansible.builtin.package:
        name: awscli
        state: "{{ awscli_package_state }}"
        update_cache: true

- name: Ensure ~/.aws directory exists
  ansible.builtin.file:
    group: "{{ item.group }}"
    mode: "0755"
    owner: "{{ item.name }}"
    path: "{{ item.home }}/.aws"
    state: directory
  loop: "{{ awscli_users }}"
  loop_control:
    label: "{{ item.name }}"

- name: Ensure ~/.aws/config file exists
  ansible.builtin.template:
    dest: "{{ item.home }}/.aws/config"
    group: "{{ item.group }}"
    mode: "0644"
    owner: "{{ item.name }}"
    src: config.j2
  loop: "{{ awscli_users }}"
  loop_control:
    label: "{{ item.name }}"

- name: Ensure ~/.aws/credentials file exists
  ansible.builtin.template:
    dest: "{{ item.home }}/.aws/credentials"
    group: "{{ item.group }}"
    mode: "0644"
    owner: "{{ item.name }}"
    src: credentials.j2
  loop: "{{ awscli_users }}"
  loop_control:
    label: "{{ item.name }}"
